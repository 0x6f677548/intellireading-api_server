---
name: deploy_to_dockerhost
# yamllint disable rule:line-length

on:
  release:
    types: [released]
  workflow_dispatch:
    
run-name: ${{ github.ref_name }} -> deploy_to_dockerhost (
  ${{ github.run_attempt }}
  )

    
jobs:
  deploy_to_dockerhost:
    name: deploy_to_dockerhost
    runs-on: ubuntu-latest

    steps:
      - name: Get current date and time
        id: datetime
        run: echo "datetime=$(date +'%Y-%m-%dT%H-%M-%SZ')" >> $GITHUB_OUTPUT

      - name: Display date/time in output (forensics when triaging issues)
        run: echo ${{ steps.datetime.outputs.datetime }}

      - uses: actions/checkout@v4
      
      - name: Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci


      - name: ssh deploy
        run: |
          ssh -o "StrictHostKeyChecking no" ${{ secrets.PROD_SSH_USER }}@${{ secrets.PROD_SSH_HOST }} "
           mkdir -p /apps/${{ github.event.repository.name }} &&
            cd /apps/${{ github.event.repository.name }} &&
            [ -f docker-compose.prod.yml ] && docker compose --env-file .env.prod down &&
            rsync -avzi --delete --exclude=log/ --exclude-from=.deploy/rsync-exclusions ${{ github.workspace }}/ ./
            sed -i -e 's,@@API_SERVER_TURNSTILE_SECRET_KEY@@,${{ secrets.API_SERVER_TURNSTILE_SECRET_KEY}},g' docker-compose.prod.yml &&
            sed -i -e 's,@@OTEL_COLLECTOR_OTEL_EXPORTER_OTLP_ENDPOINT@@,${{ secrets.OTEL_COLLECTOR_OTEL_EXPORTER_OTLP_ENDPOINT}},g' docker-compose.prod.yml &&
            sed -i -e 's,@@OTEL_COLLECTOR_OTEL_EXPORTER_OTLP_API_KEY@@,${{ secrets.OTEL_COLLECTOR_OTEL_EXPORTER_OTLP_API_KEY}},g' docker-compose.prod.yml &&
            sed -i -e 's,@@API_SERVER_API_KEY@@,${{ secrets.API_SERVER_API_KEY}},g' docker-compose.prod.yml &&
            docker compose --env-file .env.prod up -d --remove-orphans --build
          "
